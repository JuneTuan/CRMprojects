# 客户管理功能需求文档 (PRD)

## 1. 功能概述

客户管理是JunLite CRM系统的核心功能模块，负责管理客户信息、客户等级、客户积分等核心数据。通过客户管理功能，企业可以全面了解客户情况，提供个性化服务，提升客户满意度和忠诚度。

## 2. 用户故事

### 2.1 管理员管理客户
**作为** 管理员  
**我想要** 查看和管理所有客户信息  
**以便** 了解客户情况，提供更好的服务

### 2.2 管理员创建客户
**作为** 管理员  
**我想要** 手动创建客户账户  
**以便** 为线下客户开通线上服务

### 2.3 管理员编辑客户信息
**作为** 管理员  
**我想要** 修改客户的基本信息  
**以便** 保持客户信息的准确性

### 2.4 管理员查看客户积分
**作为** 管理员  
**我想要** 查看客户的积分余额和历史记录  
**以便** 了解客户的积分情况

### 2.5 管理员调整客户积分
**作为** 管理员  
**我想要** 手动增加或减少客户积分  
**以便** 处理特殊情况和奖励客户

### 2.6 管理员查看客户订单
**作为** 管理员  
**我想要** 查看客户的订单历史  
**以便** 了解客户的购买行为

### 2.7 管理员重置客户密码
**作为** 管理员  
**我想要** 重置客户的登录密码  
**以便** 帮助忘记密码的客户恢复账户

### 2.8 管理员删除客户
**作为** 管理员  
**我想要** 删除无效或违规的客户账户  
**以便** 维护系统的数据质量

### 2.9 客户查看个人信息
**作为** 客户  
**我想要** 查看我的个人信息和会员等级  
**以便** 了解我的账户状态

### 2.10 客户修改个人信息
**作为** 客户  
**我想要** 修改我的个人信息  
**以便** 保持信息的准确性

### 2.11 客户查看积分记录
**作为** 客户  
**我想要** 查看我的积分获取和消耗记录  
**以便** 了解我的积分变化情况

### 2.12 客户修改密码
**作为** 客户  
**我想要** 修改我的登录密码  
**以便** 保护账户安全

## 3. 业务流程

### 3.1 客户创建流程

```
管理员填写客户信息 → 系统验证数据 → 生成客户编码 → 加密密码 → 保存客户信息 → 返回客户信息
```

#### 3.1.1 客户信息验证
- 客户名称不能为空
- 手机号必须符合格式且唯一
- 邮箱格式必须正确（如果提供）
- 密码长度至少6位

#### 3.1.2 客户编码生成
- 格式：CUST_时间戳
- 示例：CUST_1708329600000
- 确保唯一性

#### 3.1.3 密码处理
- 使用bcrypt加密，盐值轮次为10
- 后台新增客户默认密码为123456
- 客户注册时使用用户提供的密码

### 3.2 客户信息更新流程

```
管理员修改客户信息 → 系统验证数据 → 更新客户信息 → 记录更新时间 → 返回更新结果
```

#### 3.2.1 可更新字段
- 客户名称
- 手机号（需要验证唯一性）
- 邮箱
- 头像
- 职位
- 地址
- 所属管理员（ownerId）

#### 3.2.2 不可更新字段
- 客户编码（customerCode）
- 客户ID（customerId）
- 积分（points）
- 总消费额（totalConsumption）
- 创建时间（createdAt）

### 3.3 积分管理流程

#### 3.3.1 增加积分
```
管理员发起增加积分 → 验证客户存在 → 增加客户积分 → 创建积分记录 → 返回结果
```

**积分来源**：
- 订单完成
- 管理员手动增加
- 活动奖励
- 其他奖励

#### 3.3.2 减少积分
```
管理员发起减少积分 → 验证客户存在和积分充足 → 减少客户积分 → 创建积分记录 → 返回结果
```

**积分消耗**：
- 抽奖消耗
- 积分兑换
- 管理员手动扣除
- 其他消耗

#### 3.3.3 积分记录
每次积分变动都会创建积分记录，包含：
- 客户ID
- 变动类型（增加/减少）
- 积分数量
- 变动原因
- 变动时间
- 关联订单ID（如果适用）

### 3.4 密码管理流程

#### 3.4.1 修改密码（客户）
```
客户输入旧密码 → 验证旧密码正确 → 输入新密码 → 验证新密码格式 → 更新密码 → 返回成功
```

#### 3.4.2 重置密码（管理员）
```
管理员选择客户 → 输入新密码 → 验证密码格式 → 更新密码 → 返回成功
```

**密码要求**：
- 长度至少6位
- 建议包含字母和数字
- 使用bcrypt加密存储

### 3.5 客户删除流程

```
管理员发起删除 → 验证客户存在 → 检查关联数据 → 软删除或硬删除 → 返回结果
```

**删除策略**：
- 软删除：标记为已删除，保留数据
- 硬删除：物理删除数据

**注意事项**：
- 删除前检查是否有未完成订单
- 删除前检查是否有未使用优惠券
- 删除后相关数据如何处理（订单、积分记录等）

## 4. 功能需求

### 4.1 管理端功能

#### 4.1.1 客户列表
- 分页展示客户列表
- 支持按客户名称搜索
- 支持按手机号搜索
- 显示客户基本信息：编码、名称、手机号、积分、等级、状态
- 支持按创建时间排序
- 显示客户总数

#### 4.1.2 客户详情
- 显示客户完整信息
- 显示客户等级信息
- 显示积分余额
- 显示总消费额
- 显示所属管理员
- 显示创建时间和更新时间
- 显示客户头像

#### 4.1.3 创建客户
- 填写客户基本信息
- 设置初始密码
- 选择所属管理员
- 选择客户来源（后台新增/注册）
- 自动生成客户编码
- 验证数据有效性

#### 4.1.4 编辑客户
- 修改客户基本信息
- 修改所属管理员
- 修改客户头像
- 修改职位和地址
- 验证数据有效性

#### 4.1.5 删除客户
- 删除客户账户
- 确认删除操作
- 提示删除影响

#### 4.1.6 积分管理
- 查看客户积分余额
- 查看积分历史记录
- 手动增加积分
- 手动减少积分
- 查看积分变动明细

#### 4.1.7 客户订单
- 查看客户的订单列表
- 按时间、状态筛选订单
- 显示订单总金额
- 显示订单数量

#### 4.1.8 密码管理
- 重置客户密码
- 设置新密码

#### 4.1.9 客户统计
- 客户总数统计
- 新增客户统计（日/周/月）
- 活跃客户统计
- 客户积分分布
- 客户等级分布

### 4.2 用户端功能

#### 4.2.1 个人中心
- 显示客户基本信息
- 显示会员等级和等级图标
- 显示积分余额
- 显示总消费额
- 显示客户头像

#### 4.2.2 个人信息编辑
- 修改客户名称
- 修改手机号（需要验证）
- 修改邮箱
- 修改头像
- 修改职位
- 修改地址

#### 4.2.3 积分中心
- 查看积分余额
- 查看积分历史记录
- 查看积分获取明细
- 查看积分消耗明细
- 显示积分变动原因

#### 4.2.4 修改密码
- 输入旧密码
- 输入新密码
- 确认新密码
- 验证旧密码正确性
- 更新密码

#### 4.2.5 我的订单
- 查看订单列表
- 查看订单详情
- 按状态筛选订单
- 显示订单总金额

#### 4.2.6 我的优惠券
- 查看优惠券列表
- 查看优惠券详情
- 显示优惠券状态
- 显示优惠券有效期

## 5. 技术实现

### 5.1 数据模型

#### 5.1.1 客户 (Customer)
```typescript
{
  customerId: number              // 客户ID（主键）
  customerCode: string            // 客户编码（唯一）
  customerName: string            // 客户名称
  phone: string                   // 手机号（唯一）
  email: string                   // 邮箱
  password: string                // 密码（加密）
  points: number                  // 积分余额
  totalConsumption: number        // 总消费额
  memberLevelId: number           // 会员等级ID（外键）
  ownerId: number                 // 所属管理员ID（外键）
  avatar: string                  // 头像URL
  position: string                // 职位
  address: string                 // 地址
  status: string                  // 状态：正常/禁用
  source: string                  // 来源：后台新增/注册
  createdAt: Date                // 创建时间
  updatedAt: Date                // 更新时间
}
```

#### 5.1.2 积分记录 (PointsRecord)
```typescript
{
  id: number                      // 积分记录ID（主键）
  customerId: number             // 客户ID（外键）
  type: string                   // 类型：增加/减少
  points: number                 // 积分数量
  reason: string                 // 变动原因
  orderId: number                // 关联订单ID（外键，可选）
  createdAt: Date                // 创建时间
}
```

#### 5.1.3 会员等级 (MemberLevel)
```typescript
{
  levelId: number                 // 等级ID（主键）
  levelCode: string               // 等级编码（唯一）
  levelName: string               // 等级名称
  iconCode: string                // 图标编码
  minPoints: number               // 最低积分要求
  minConsumption: number          // 最低消费要求
  discount: number                // 折扣比例
  description: string             // 描述
  createdAt: Date                 // 创建时间
  updatedAt: Date                 // 更新时间
}
```

#### 5.1.4 会员等级变更记录 (MemberLevelLog)
```typescript
{
  id: number                      // 记录ID（主键）
  customerId: number             // 客户ID（外键）
  oldLevelId: number              // 原等级ID（外键）
  newLevelId: number              // 新等级ID（外键）
  points: number                  // 升级时积分
  consumption: number            // 升级时消费额
  reason: string                 // 变动原因
  createdAt: Date                // 创建时间
}
```

### 5.2 核心算法

#### 5.2.1 客户编码生成
```typescript
function generateCustomerCode(): string {
  const timestamp = Date.now();
  return `CUST_${timestamp}`;
}
```

#### 5.2.2 密码加密
```typescript
async function hashPassword(password: string): Promise<string> {
  const saltRounds = 10;
  return await bcrypt.hash(password, saltRounds);
}
```

#### 5.2.3 积分增加
```typescript
async function addPoints(customerId: number, points: number, reason: string, orderId?: number) {
  const customer = await customerRepository.findOne({ where: { customerId } });
  if (!customer) {
    throw new NotFoundException('客户不存在');
  }
  
  customer.points += points;
  await customerRepository.save(customer);
  
  await pointsRecordRepository.create({
    customerId,
    type: '增加',
    points,
    reason,
    orderId,
  });
  
  await memberLevelService.checkAndUpgradeLevel(customerId);
}
```

#### 5.2.4 积分减少
```typescript
async function usePoints(customerId: number, points: number, reason: string, orderId?: number) {
  const customer = await customerRepository.findOne({ where: { customerId } });
  if (!customer) {
    throw new NotFoundException('客户不存在');
  }
  
  if (customer.points < points) {
    throw new BadRequestException('积分不足');
  }
  
  customer.points -= points;
  await customerRepository.save(customer);
  
  await pointsRecordRepository.create({
    customerId,
    type: '减少',
    points,
    reason,
    orderId,
  });
}
```

#### 5.2.5 会员等级升级
```typescript
async function checkAndUpgradeLevel(customerId: number) {
  const customer = await customerRepository.findOne({
    where: { customerId },
    relations: ['memberLevel'],
  });
  
  if (!customer) {
    throw new NotFoundException('客户不存在');
  }
  
  const allLevels = await memberLevelRepository.find({
    order: { minPoints: 'ASC', minConsumption: 'ASC' },
  });
  
  let targetLevel = null;
  for (const level of allLevels) {
    if (customer.points >= level.minPoints && 
        customer.totalConsumption >= level.minConsumption) {
      targetLevel = level;
    }
  }
  
  if (targetLevel && targetLevel.levelId !== customer.memberLevelId) {
    const oldLevelId = customer.memberLevelId;
    customer.memberLevelId = targetLevel.levelId;
    await customerRepository.save(customer);
    
    await memberLevelLogRepository.create({
      customerId,
      oldLevelId,
      newLevelId: targetLevel.levelId,
      points: customer.points,
      consumption: customer.totalConsumption,
      reason: '积分和消费达标自动升级',
    });
  }
}
```

### 5.3 接口设计

#### 5.3.1 管理端接口

**GET /customers**
- 获取客户列表
- 查询参数：page, pageSize, search
- 返回：客户列表、总数、分页信息

**GET /customers/:id**
- 获取客户详情
- 返回：客户完整信息

**POST /customers**
- 创建客户
- 请求体：客户信息
- 返回：创建的客户信息

**PUT /customers/:id**
- 更新客户信息
- 请求体：更新的客户信息
- 返回：更新后的客户信息

**DELETE /customers/:id**
- 删除客户
- 返回：删除结果

**GET /customers/:id/points-history**
- 获取客户积分历史
- 查询参数：page, pageSize, type
- 返回：积分记录列表、总数

**POST /customers/:id/add-points**
- 增加客户积分
- 请求体：{ points, reason, orderId }
- 返回：更新后的客户信息

**POST /customers/:id/use-points**
- 减少客户积分
- 请求体：{ points, reason, orderId }
- 返回：更新后的客户信息

**GET /customers/:id/orders**
- 获取客户订单列表
- 查询参数：page, pageSize, status
- 返回：订单列表、总数

**PUT /customers/:id/password**
- 重置客户密码
- 请求体：{ newPassword }
- 返回：更新结果

**GET /statistics/customers**
- 获取客户统计数据
- 返回：客户总数、新增客户、活跃客户等

#### 5.3.2 用户端接口

**GET /h5/customer/info**
- 获取客户信息
- 返回：客户信息、会员等级、积分等

**PUT /h5/customer/info**
- 更新客户信息
- 请求体：更新的客户信息
- 返回：更新后的客户信息

**GET /h5/customer/points-history**
- 获取积分历史记录
- 查询参数：page, pageSize, type
- 返回：积分记录列表、总数

**PUT /h5/customer/password**
- 修改密码
- 请求体：{ oldPassword, newPassword }
- 返回：更新结果

**GET /h5/customer/orders**
- 获取客户订单列表
- 查询参数：page, pageSize, status
- 返回：订单列表、总数

**GET /h5/customer/coupons**
- 获取客户优惠券列表
- 查询参数：page, pageSize, status
- 返回：优惠券列表、总数

## 6. 业务规则

### 6.1 客户注册规则

1. **手机号唯一性**
   - 手机号必须唯一
   - 注册时验证手机号是否已存在

2. **密码要求**
   - 密码长度至少6位
   - 建议包含字母和数字
   - 使用bcrypt加密存储

3. **初始等级**
   - 新注册客户默认为普通会员
   - 可以通过积分和消费升级

### 6.2 积分规则

1. **积分获取**
   - 订单完成获得积分
   - 管理员手动增加积分
   - 活动奖励积分
   - 积分不能为负数

2. **积分消耗**
   - 抽奖消耗积分
   - 积分兑换商品
   - 管理员手动扣除积分
   - 积分余额必须充足

3. **积分记录**
   - 每次积分变动都会创建记录
   - 记录包含变动原因和时间
   - 支持查询历史记录

### 6.3 会员等级规则

1. **等级升级**
   - 基于积分和消费额自动升级
   - 达到最低要求即可升级
   - 升级后享受相应折扣

2. **等级降级**
   - 暂不支持等级降级
   - 等级一旦升级不会降低

3. **等级权益**
   - 不同等级享受不同折扣
   - 高等级客户享受更多权益
   - 等级图标显示在个人中心

### 6.4 客户管理规则

1. **客户删除**
   - 删除前检查关联数据
   - 建议使用软删除
   - 删除后数据如何处理

2. **客户信息修改**
   - 手机号修改需要验证
   - 邮箱格式必须正确
   - 修改后记录更新时间

3. **密码安全**
   - 密码必须加密存储
   - 修改密码需要验证旧密码
   - 重置密码需要管理员权限

## 7. 用户体验

### 7.1 管理端体验

1. **列表展示**
   - 清晰的客户列表
   - 支持快速搜索
   - 分页加载优化

2. **信息查看**
   - 客户详情页展示完整信息
   - 积分和订单一目了然
   - 支持快速操作

3. **操作便捷**
   - 一键创建客户
   - 快速编辑客户信息
   - 便捷的积分管理

### 7.2 用户端体验

1. **个人中心**
   - 清晰展示个人信息
   - 会员等级和积分明显
   - 头像和状态直观

2. **信息修改**
   - 简单的表单填写
   - 实时验证输入
   - 修改成功提示

3. **积分查询**
   - 积分余额明显
   - 积分历史清晰
   - 变动原因详细

## 8. 统计分析

### 8.1 关键指标

1. **客户指标**
   - 客户总数
   - 新增客户数（日/周/月）
   - 活跃客户数
   - 客户流失率

2. **积分指标**
   - 积分发放总额
   - 积分消耗总额
   - 积分余额总额
   - 积分使用率

3. **等级指标**
   - 各等级客户数量
   - 等级升级趋势
   - 等级分布情况

### 8.2 报表功能

1. **客户报表**
   - 客户增长趋势
   - 客户活跃度分析
   - 客户价值分析

2. **积分报表**
   - 积分发放统计
   - 积分消耗统计
   - 积分使用分析

## 9. 后续优化

### 9.1 功能增强

1. **客户标签**
   - 为客户打标签
   - 基于标签筛选客户
   - 标签统计分析

2. **客户画像**
   - 客户行为分析
   - 消费偏好分析
   - 个性化推荐

3. **客户生命周期**
   - 新客户识别
   - 活跃客户识别
   - 沉睡客户识别
   - 流失客户识别

### 9.2 性能优化

1. **缓存优化**
   - 客户信息缓存
   - 积分余额缓存
   - 等级信息缓存

2. **查询优化**
   - 索引优化
   - 查询语句优化
   - 分页查询优化

## 10. 版本规划

### 10.1 V1.0（当前版本）
- ✅ 客户基本信息管理
- ✅ 积分管理
- ✅ 会员等级管理
- ✅ 密码管理
- ✅ 基础统计功能

### 10.2 V1.1（规划中）
- 🔄 客户标签功能
- 🔄 客户画像分析
- 🔄 客户生命周期管理
- 🔄 高级统计分析

### 10.3 V2.0（未来规划）
- ⏳ AI客户分析
- ⏳ 智能推荐系统
- ⏳ 客户行为预测
- ⏳ 自动化营销

---

**文档版本**: 1.0  
**最后更新**: 2026-02-19  
**维护人**: JunLite CRM Team