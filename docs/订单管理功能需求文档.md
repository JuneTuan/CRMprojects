# 订单管理功能需求文档 (PRD)

## 1. 功能概述

订单管理是JunLite CRM系统的核心交易功能模块，负责管理客户订单的完整生命周期，包括订单创建、支付、发货、完成、取消等环节。通过订单管理功能，企业可以高效处理客户订单，提供优质的购物体验。

## 2. 用户故事

### 2.1 管理员查看订单列表
**作为** 管理员  
**我想要** 查看所有订单列表  
**以便** 了解订单情况和处理订单

### 2.2 管理员创建订单
**作为** 管理员  
**我想要** 手动为客户创建订单  
**以便** 处理线下订单或特殊订单

### 2.3 管理员编辑订单
**作为** 管理员  
**我想要** 修改订单信息  
**以便** 修正订单错误或调整订单

### 2.4 管理员支付订单
**作为** 管理员  
**我想要** 标记订单为已支付  
**以便** 处理线下支付或特殊支付情况

### 2.5 管理员取消订单
**作为** 管理员  
**我想要** 取消订单  
**以便** 处理客户取消或异常订单

### 2.6 管理员删除订单
**作为** 管理员  
**我想要** 删除无效订单  
**以便** 保持订单数据的准确性

### 2.7 管理员查看订单详情
**作为** 管理员  
**我想要** 查看订单的详细信息  
**以便** 了解订单的所有细节

### 2.8 客户创建订单
**作为** 客户  
**我想要** 下单购买商品  
**以便** 获得需要的商品

### 2.9 客户查看我的订单
**作为** 客户  
**我想要** 查看我的订单列表  
**以便** 了解订单状态和历史

### 2.10 客户查看订单详情
**作为** 客户  
**我想要** 查看订单的详细信息  
**以便** 了解订单的具体内容

### 2.11 客户取消订单
**作为** 客户  
**我想要** 取消未支付的订单  
**以便** 修改购买计划

## 3. 业务流程

### 3.1 订单创建流程

```
选择客户 → 选择商品 → 设置数量 → 计算金额 → 选择支付方式 → 确认订单 → 创建订单 → 扣减库存 → 返回订单信息
```

#### 3.1.1 订单信息验证
- 客户必须存在
- 商品必须存在
- 商品库存必须充足
- 数量必须大于0
- 单价必须大于0

#### 3.1.2 订单金额计算
- 订单总额 = Σ(商品单价 × 数量)
- 实际金额 = 订单总额（暂不考虑折扣）
- 如果使用积分支付，需要验证积分充足

#### 3.1.3 订单号生成
- 格式：ORD_时间戳_随机数
- 示例：ORD_1708329600000_1234
- 确保唯一性

#### 3.1.4 库存扣减
- 创建订单时扣减商品库存
- 如果库存不足，创建失败
- 取消订单时恢复库存

#### 3.1.5 积分处理
- 如果订单使用积分支付，扣除客户积分
- 如果订单完成后获得积分，增加客户积分
- 创建积分记录

### 3.2 订单支付流程

```
选择订单 → 选择支付方式 → 确认支付 → 更新订单状态 → 触发后续流程 → 返回结果
```

#### 3.2.1 支付方式
- 微信支付
- 支付宝支付
- 积分支付
- 线下支付
- 其他支付方式

#### 3.2.2 支付验证
- 订单状态必须为"待支付"
- 支付金额必须匹配
- 支付方式必须有效

#### 3.2.3 支付后处理
- 更新订单状态为"已支付"
- 记录支付时间
- 记录支付方式
- 触发发货流程

### 3.3 订单取消流程

```
选择订单 → 验证订单状态 → 恢复库存 → 更新订单状态 → 记录取消原因 → 返回结果
```

#### 3.3.1 取消条件
- 订单状态为"待支付"或"已支付"
- 未发货的订单可以取消
- 已发货的订单需要特殊处理

#### 3.3.2 库存恢复
- 取消订单时恢复商品库存
- 增加商品库存数量
- 更新商品库存信息

#### 3.3.3 积分处理
- 如果订单使用积分支付，退还积分
- 创建积分退还记录
- 更新客户积分余额

### 3.4 订单完成流程

```
订单发货 → 客户确认收货 → 更新订单状态 → 发放积分 → 更新客户消费 → 检查会员升级 → 返回结果
```

#### 3.4.1 订单完成条件
- 订单已发货
- 客户确认收货
- 或自动确认收货（7天后）

#### 3.4.2 积分发放
- 根据订单金额计算积分
- 增加客户积分
- 创建积分记录
- 积分 = 订单金额 × 积分比例

#### 3.4.3 消费更新
- 增加客户总消费额
- 更新客户消费信息
- 用于会员等级计算

#### 3.4.4 会员升级
- 检查客户是否达到升级条件
- 自动升级会员等级
- 创建等级变更记录

### 3.5 订单删除流程

```
选择订单 → 验证订单状态 → 删除订单 → 删除订单项 → 返回结果
```

#### 3.5.1 删除条件
- 订单状态为"已取消"
- 或订单数据无效
- 需要管理员权限

#### 3.5.2 数据清理
- 删除订单主记录
- 删除订单项记录
- 保留相关数据（积分记录等）

## 4. 功能需求

### 4.1 管理端功能

#### 4.1.1 订单列表
- 分页展示订单列表
- 支持按订单号搜索
- 支持按客户搜索
- 支持按状态筛选（待支付/已支付/已取消/已完成）
- 支持按时间范围筛选
- 显示订单基本信息：订单号、客户、金额、状态、支付方式、创建时间
- 支持按创建时间排序
- 显示订单总数

#### 4.1.2 订单详情
- 显示订单完整信息
- 显示订单项列表
- 显示客户信息
- 显示支付信息
- 显示物流信息
- 显示订单状态变更历史

#### 4.1.3 创建订单
- 选择客户
- 选择商品
- 设置商品数量
- 计算订单金额
- 选择支付方式
- 设置收货地址
- 验证库存充足
- 创建订单

#### 4.1.4 编辑订单
- 修改订单基本信息
- 修改订单项（增删改）
- 修改收货地址
- 修改支付方式
- 重新计算金额
- 验证库存充足

#### 4.1.5 支付订单
- 选择支付方式
- 确认支付金额
- 更新订单状态
- 记录支付信息

#### 4.1.6 取消订单
- 选择取消原因
- 验证订单状态
- 恢复商品库存
- 退还积分（如果使用积分支付）
- 更新订单状态

#### 4.1.7 删除订单
- 验证订单状态
- 删除订单记录
- 删除订单项记录

#### 4.1.8 订单统计
- 订单总数统计
- 订单金额统计（日/周/月）
- 订单状态分布
- 支付方式统计
- 客户订单统计

### 4.2 用户端功能

#### 4.2.1 创建订单
- 选择商品
- 设置购买数量
- 查看商品详情
- 计算订单金额
- 选择支付方式
- 填写收货地址
- 确认订单

#### 4.2.2 我的订单
- 查看订单列表
- 按状态筛选订单
- 显示订单基本信息
- 显示订单状态
- 支持分页加载

#### 4.2.3 订单详情
- 查看订单完整信息
- 查看订单项列表
- 查看支付信息
- 查看物流信息
- 查看订单状态

#### 4.2.4 取消订单
- 选择取消原因
- 验证订单状态
- 取消订单
- 恢复库存

#### 4.2.5 确认收货
- 确认收到商品
- 更新订单状态
- 触发积分发放

## 5. 技术实现

### 5.1 数据模型

#### 5.1.1 订单 (Order)
```typescript
{
  orderId: number                  // 订单ID（主键）
  orderNo: string                  // 订单号（唯一）
  customerId: number               // 客户ID（外键）
  totalAmount: number               // 订单总额
  actualAmount: number             // 实际金额
  discountAmount: number           // 折扣金额
  status: string                   // 状态：待支付/已支付/已取消/已完成
  paymentMethod: string            // 支付方式
  paymentTime: Date               // 支付时间
  shippingAddress: string          // 收货地址
  shippingTime: Date              // 发货时间
  completedTime: Date             // 完成时间
  cancelReason: string            // 取消原因
  cancelTime: Date                // 取消时间
  isPoints: boolean               // 是否使用积分支付
  points: number                  // 使用积分数量
  createdAt: Date                 // 创建时间
  updatedAt: Date                 // 更新时间
}
```

#### 5.1.2 订单项 (OrderItem)
```typescript
{
  id: number                       // 订单项ID（主键）
  orderId: number                 // 订单ID（外键）
  productId: number                // 商品ID（外键）
  productName: string             // 商品名称
  productImage: string            // 商品图片
  quantity: number                // 数量
  unitPrice: number               // 单价
  subtotal: number                // 小计
  createdAt: Date                 // 创建时间
}
```

### 5.2 核心算法

#### 5.2.1 订单号生成
```typescript
function generateOrderNo(): string {
  const timestamp = Date.now();
  const random = Math.floor(Math.random() * 10000);
  return `ORD_${timestamp}_${random}`;
}
```

#### 5.2.2 订单金额计算
```typescript
function calculateOrderAmount(orderItems: OrderItem[]): {
  totalAmount: number,
  actualAmount: number,
  discountAmount: number
} {
  const totalAmount = orderItems.reduce((sum, item) => {
    return sum + (item.unitPrice * item.quantity);
  }, 0);
  
  const discountAmount = 0;
  const actualAmount = totalAmount - discountAmount;
  
  return { totalAmount, actualAmount, discountAmount };
}
```

#### 5.2.3 创建订单
```typescript
async function createOrder(createOrderDto: CreateOrderDto) {
  const { customerId, orderItems, paymentMethod, shippingAddress, isPoints, points } = createOrderDto;
  
  const customer = await customerService.findOne(customerId);
  if (!customer) {
    throw new NotFoundException('客户不存在');
  }
  
  for (const item of orderItems) {
    const product = await productService.findOne(item.productId);
    if (!product) {
      throw new NotFoundException(`商品 ${item.productId} 不存在`);
    }
    
    if (product.stock < item.quantity) {
      throw new BadRequestException(`商品 ${product.productName} 库存不足`);
    }
  }
  
  if (isPoints && points > 0) {
    if (customer.points < points) {
      throw new BadRequestException('积分不足');
    }
  }
  
  const orderNo = generateOrderNo();
  const { totalAmount, actualAmount, discountAmount } = calculateOrderAmount(orderItems);
  
  const order = orderRepository.create({
    orderNo,
    customerId,
    totalAmount,
    actualAmount,
    discountAmount,
    status: '待支付',
    paymentMethod,
    shippingAddress,
    isPoints,
    points,
  });
  const savedOrder = await orderRepository.save(order);
  
  for (const item of orderItems) {
    const product = await productService.findOne(item.productId);
    
    const orderItem = orderItemRepository.create({
      orderId: savedOrder.orderId,
      productId: item.productId,
      productName: product.productName,
      productImage: product.imageUrl,
      quantity: item.quantity,
      unitPrice: item.unitPrice,
      subtotal: item.quantity * item.unitPrice,
    });
    await orderItemRepository.save(orderItem);
    
    product.stock -= item.quantity;
    await productService.update(product.productId, { stock: product.stock });
  }
  
  if (isPoints && points > 0) {
    await customerService.usePoints(customerId, points, '订单支付', savedOrder.orderId);
  }
  
  return savedOrder;
}
```

#### 5.2.4 支付订单
```typescript
async function payOrder(orderId: number, paymentMethod: string) {
  const order = await orderRepository.findOne({ where: { orderId } });
  if (!order) {
    throw new NotFoundException('订单不存在');
  }
  
  if (order.status !== '待支付') {
    throw new BadRequestException('订单状态不正确');
  }
  
  order.status = '已支付';
  order.paymentMethod = paymentMethod;
  order.paymentTime = new Date();
  await orderRepository.save(order);
  
  return order;
}
```

#### 5.2.5 取消订单
```typescript
async function cancelOrder(orderId: number, reason: string) {
  const order = await orderRepository.findOne({ where: { orderId } });
  if (!order) {
    throw new NotFoundException('订单不存在');
  }
  
  if (order.status !== '待支付' && order.status !== '已支付') {
    throw new BadRequestException('订单状态不正确');
  }
  
  const orderItems = await orderItemRepository.find({ where: { orderId } });
  for (const item of orderItems) {
    const product = await productService.findOne(item.productId);
    product.stock += item.quantity;
    await productService.update(product.productId, { stock: product.stock });
  }
  
  if (order.isPoints && order.points > 0) {
    await customerService.addPoints(order.customerId, order.points, '订单取消退还', order.orderId);
  }
  
  order.status = '已取消';
  order.cancelReason = reason;
  order.cancelTime = new Date();
  await orderRepository.save(order);
  
  return order;
}
```

#### 5.2.6 完成订单
```typescript
async function completeOrder(orderId: number) {
  const order = await orderRepository.findOne({ where: { orderId } });
  if (!order) {
    throw new NotFoundException('订单不存在');
  }
  
  if (order.status !== '已支付') {
    throw new BadRequestException('订单状态不正确');
  }
  
  order.status = '已完成';
  order.completedTime = new Date();
  await orderRepository.save(order);
  
  const earnedPoints = Math.floor(order.actualAmount * 0.01);
  if (earnedPoints > 0) {
    await pointsRecordService.createPointsRecord(
      order.customerId,
      '订单完成',
      earnedPoints,
      `订单 ${order.orderNo} 完成获得积分`,
    );
  }
  
  await customerService.updateConsumption(order.customerId, Number(order.actualAmount));
  
  await memberLevelService.checkAndUpgradeLevel(order.customerId);
  
  return order;
}
```

### 5.3 接口设计

#### 5.3.1 管理端接口

**GET /orders**
- 获取订单列表
- 查询参数：page, pageSize, status, customerId, startDate, endDate
- 返回：订单列表、总数、分页信息

**GET /orders/:id**
- 获取订单详情
- 返回：订单完整信息、订单项列表

**POST /orders**
- 创建订单
- 请求体：订单信息
- 返回：创建的订单信息

**PUT /orders/:id**
- 更新订单信息
- 请求体：更新的订单信息
- 返回：更新后的订单信息

**PUT /orders/:id/pay**
- 支付订单
- 请求体：{ paymentMethod }
- 返回：更新后的订单信息

**PUT /orders/:id/cancel**
- 取消订单
- 请求体：{ reason }
- 返回：更新后的订单信息

**DELETE /orders/:id**
- 删除订单
- 返回：删除结果

**GET /statistics/orders**
- 获取订单统计数据
- 返回：订单总数、金额统计、状态分布等

#### 5.3.2 用户端接口

**POST /h5/orders**
- 创建订单
- 请求体：订单信息
- 返回：创建的订单信息

**GET /h5/orders**
- 获取客户订单列表
- 查询参数：page, pageSize, status
- 返回：订单列表、总数

**GET /h5/orders/:id**
- 获取订单详情
- 返回：订单完整信息、订单项列表

**PUT /h5/orders/:id/cancel**
- 取消订单
- 请求体：{ reason }
- 返回：更新后的订单信息

**PUT /h5/orders/:id/confirm**
- 确认收货
- 返回：更新后的订单信息

## 6. 业务规则

### 6.1 订单创建规则

1. **库存验证**
   - 创建订单时验证库存充足
   - 库存不足时创建失败
   - 创建订单时扣减库存

2. **积分支付**
   - 使用积分支付需要验证积分充足
   - 积分不足时无法创建订单
   - 创建订单时扣除积分

3. **订单金额**
   - 订单金额 = Σ(商品单价 × 数量)
   - 暂不考虑折扣
   - 金额必须大于0

### 6.2 订单支付规则

1. **支付条件**
   - 订单状态必须为"待支付"
   - 支付金额必须匹配
   - 支付方式必须有效

2. **支付方式**
   - 支持多种支付方式
   - 记录支付时间
   - 更新订单状态

### 6.3 订单取消规则

1. **取消条件**
   - 订单状态为"待支付"或"已支付"
   - 未发货的订单可以取消
   - 已发货的订单需要特殊处理

2. **库存恢复**
   - 取消订单时恢复库存
   - 增加商品库存数量
   - 更新商品库存信息

3. **积分退还**
   - 使用积分支付的订单取消时退还积分
   - 创建积分退还记录
   - 更新客户积分余额

### 6.4 订单完成规则

1. **完成条件**
   - 订单已发货
   - 客户确认收货
   - 或自动确认收货（7天后）

2. **积分发放**
   - 根据订单金额计算积分
   - 积分 = 订单金额 × 1%
   - 增加客户积分

3. **消费更新**
   - 增加客户总消费额
   - 用于会员等级计算
   - 触发会员升级检查

### 6.5 订单删除规则

1. **删除条件**
   - 订单状态为"已取消"
   - 或订单数据无效
   - 需要管理员权限

2. **数据清理**
   - 删除订单主记录
   - 删除订单项记录
   - 保留相关数据

## 7. 用户体验

### 7.1 管理端体验

1. **列表展示**
   - 清晰的订单列表
   - 支持快速搜索
   - 分页加载优化

2. **信息查看**
   - 订单详情页展示完整信息
   - 订单项一目了然
   - 支持快速操作

3. **操作便捷**
   - 一键创建订单
   - 快速编辑订单
   - 便捷的订单处理

### 7.2 用户端体验

1. **下单流程**
   - 简单的下单步骤
   - 清晰的商品展示
   - 实时金额计算

2. **订单查询**
   - 订单列表清晰
   - 状态明显
   - 支持筛选

3. **订单详情**
   - 完整的订单信息
   - 清晰的订单项
   - 物流信息可见

## 8. 统计分析

### 8.1 关键指标

1. **订单指标**
   - 订单总数
   - 订单金额（日/周/月）
   - 订单状态分布
   - 平均订单金额

2. **客户指标**
   - 客户订单数
   - 客户消费金额
   - 客户复购率

3. **商品指标**
   - 商品销量
   - 商品销售额
   - 热销商品排行

### 8.2 报表功能

1. **订单报表**
   - 订单趋势分析
   - 订单状态分析
   - 支付方式分析

2. **销售报表**
   - 销售额统计
   - 销量统计
   - 客户消费分析

## 9. 后续优化

### 9.1 功能增强

1. **订单流程**
   - 添加发货流程
   - 添加物流跟踪
   - 添加退款流程

2. **订单优惠**
   - 优惠券使用
   - 满减活动
   - 会员折扣

3. **订单通知**
   - 订单状态变更通知
   - 支付成功通知
   - 发货通知

### 9.2 性能优化

1. **缓存优化**
   - 订单信息缓存
   - 商品信息缓存
   - 客户信息缓存

2. **查询优化**
   - 索引优化
   - 查询语句优化
   - 分页查询优化

## 10. 版本规划

### 10.1 V1.0（当前版本）
- ✅ 订单基本信息管理
- ✅ 订单创建和编辑
- ✅ 订单支付和取消
- ✅ 订单完成处理
- ✅ 积分发放和消费更新
- ✅ 会员升级检查
- ✅ 基础统计功能

### 10.2 V1.1（规划中）
- 🔄 订单发货流程
- 🔄 物流跟踪
- 🔄 退款流程
- 🔄 订单优惠功能
- 🔄 订单通知功能

### 10.3 V2.0（未来规划）
- ⏳ 智能推荐
- ⏳ 订单预测
- ⏳ 自动化处理
- ⏳ 大数据分析

---

**文档版本**: 1.0  
**最后更新**: 2026-02-19  
**维护人**: JunLite CRM Team