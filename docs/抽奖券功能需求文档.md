# 抽奖券功能需求文档 (PRD)

## 1. 功能概述

抽奖券功能是JunLite CRM系统的核心营销功能，通过活动抽奖机制吸引用户参与，提升用户活跃度和粘性。用户可以通过免费次数或消耗积分参与抽奖，获得优惠券、实物奖品等奖励。

## 2. 用户故事

### 2.1 用户参与抽奖
**作为** 顾客  
**我想要** 参与营销活动抽奖  
**以便** 获得优惠券或奖品，享受优惠

### 2.2 查看抽奖结果
**作为** 顾客  
**我想要** 查看我的抽奖历史记录  
**以便** 了解我的中奖情况和奖品领取状态

### 2.3 使用中奖优惠券
**作为** 顾客  
**我想要** 使用我中奖获得的优惠券  
**以便** 在购物时享受折扣优惠

### 2.4 管理员配置活动
**作为** 管理员  
**我想要** 创建和配置抽奖活动  
**以便** 控制抽奖规则、奖品设置和活动时间

## 3. 业务流程

### 3.1 抽奖流程

```
用户登录 → 选择活动 → 检查抽奖资格 → 执行抽奖 → 获得结果 → 领取奖品
```

#### 3.1.1 抽奖资格检查

1. **活动状态检查**
   - 活动必须处于"进行中"状态
   - 当前时间必须在活动有效期内（startTime ≤ now ≤ endTime）

2. **游戏类型检查**
   - 选择的活动游戏类型必须存在且处于激活状态
   - 游戏类型必须关联有可用奖品

3. **抽奖次数检查**
   - 免费抽奖：每个活动最多3次免费机会
   - 积分抽奖：免费次数用完后，可以消耗积分继续抽奖

4. **积分检查**
   - 如果是积分抽奖，用户积分必须 ≥ 活动最低积分要求
   - 积分不足时提示用户

### 3.2 抽奖执行

1. **概率计算**
   - 基于奖品的probability属性计算中奖概率
   - 使用随机算法确定中奖结果
   - 确保总概率为100%

2. **奖品库存检查**
   - 中奖后检查奖品剩余数量
   - 如果奖品数量为0，则视为未中奖

3. **积分扣除**
   - 如果是积分抽奖，扣除用户积分
   - 记录积分使用原因"抽奖消耗"

4. **优惠券发放**
   - 如果中奖奖品类型为"券"，自动发放优惠券
   - 从可用优惠券池中随机选择
   - 创建用户优惠券记录，状态为"未使用"
   - 更新优惠券库存数量

### 3.3 抽奖记录

创建抽奖记录，包含：
- 客户ID
- 活动ID
- 游戏类型ID
- 奖品ID（如果中奖）
- 奖品名称（如果中奖）
- 优惠券ID（如果中奖券）
- 状态：未领取 / 未中奖
- 抽奖次数：1
- 消耗积分
- 抽奖时间

### 3.4 奖品领取

对于实物奖品：
- 状态更新为"未领取"
- 用户可以查看中奖记录
- 管理员可以处理实物奖品发放

对于优惠券奖品：
- 自动发放到用户账户
- 用户可在"我的优惠券"中查看
- 在购物时使用优惠券

## 4. 功能需求

### 4.1 用户端功能

#### 4.1.1 活动列表
- 展示所有"进行中"和"未开始"的活动
- 显示活动名称、描述、开始时间、结束时间
- 显示活动图片和游戏类型

#### 4.1.2 抽奖信息查询
- 查询指定活动的抽奖信息
- 显示剩余免费次数
- 显示消耗积分要求
- 显示用户当前积分
- 显示可抽奖状态

#### 4.1.3 执行抽奖
- 选择游戏类型参与抽奖
- 实时显示抽奖结果
- 显示中奖奖品信息
- 显示积分消耗情况

#### 4.1.4 抽奖记录
- 查看历史抽奖记录
- 显示抽奖时间、结果、奖品信息
- 显示奖品领取状态
- 支持分页查询

#### 4.1.5 我的优惠券
- 查看所有获得的优惠券
- 显示优惠券类型、面值、有效期
- 显示使用状态
- 支持优惠券核销验证

### 4.2 管理端功能

#### 4.2.1 活动管理
- 创建抽奖活动
- 编辑活动信息
- 设置活动时间范围
- 配置每日免费抽奖次数
- 配置积分抽奖开关
- 设置最低积分要求

#### 4.2.2 游戏类型管理
- 为活动添加游戏类型
- 设置游戏类型名称和描述
- 关联奖品到游戏类型
- 激活/停用游戏类型

#### 4.2.3 奖品管理
- 添加奖品到游戏类型
- 设置奖品名称、描述、图片
- 设置奖品类型（券/实物）
- 设置奖品价值（券面值）
- 设置中奖概率
- 设置奖品总数量和剩余数量

#### 4.2.4 优惠券管理
- 创建优惠券模板
- 设置优惠券类型（代金券/实物券）
- 设置优惠券面值
- 设置优惠券有效期
- 设置优惠券总数量和剩余数量
- 设置每人最大使用次数

#### 4.2.5 抽奖记录查询
- 查看所有用户的抽奖记录
- 按活动、用户、时间筛选
- 查看中奖率统计
- 导出抽奖记录

#### 4.2.6 统计分析
- 活动参与人数统计
- 抽奖次数统计
- 中奖率分析
- 奖品发放统计
- 优惠券使用率统计

## 5. 技术实现

### 5.1 数据模型

#### 5.1.1 抽奖记录 (LotteryRecord)
```typescript
{
  id: string                    // 抽奖记录ID
  customerId: number            // 客户ID
  activityId: number           // 活动ID
  gameTypeId: number           // 游戏类型ID
  prizeId: number              // 奖品ID（如果中奖）
  prizeName: string            // 奖品名称
  couponId: number             // 优惠券ID（如果中奖券）
  status: string              // 状态：未领取/未中奖
  drawCount: number           // 抽奖次数
  costPoints: number           // 消耗积分
  drawTime: Date             // 抽奖时间
  createdAt: Date            // 创建时间
  updatedAt: Date            // 更新时间
}
```

#### 5.1.2 活动游戏 (ActivityGame)
```typescript
{
  id: number                    // 活动游戏ID
  activityId: number           // 活动ID
  gameTypeId: number           // 游戏类型ID
  isActive: boolean            // 是否激活
  gamePrizes: GamePrize[]    // 关联奖品
  createdAt: Date            // 创建时间
  updatedAt: Date            // 更新时间
}
```

#### 5.1.3 游戏奖品 (GamePrize)
```typescript
{
  id: number                    // 游戏奖品ID
  activityGameId: number       // 活动游戏ID
  prizeId: number             // 奖品ID
  probability: number          // 中奖概率（0-100）
  prize: Prize               // 奖品详情
  createdAt: Date            // 创建时间
  updatedAt: Date            // 更新时间
}
```

#### 5.1.4 用户优惠券 (CustomerCoupon)
```typescript
{
  id: number                    // 用户优惠券ID
  customerId: number           // 客户ID
  couponId: number             // 优惠券ID
  status: string              // 状态：未使用/已使用/已过期
  receivedAt: Date           // 领取时间
  usedAt: Date              // 使用时间
  createdAt: Date            // 创建时间
  updatedAt: Date            // 更新时间
}
```

### 5.2 核心算法

#### 5.2.1 抽奖概率算法
```typescript
function randomPrize(prizes: GamePrize[]): Prize | null {
  const totalProbability = prizes.reduce((sum, gp) => sum + gp.probability, 0);
  const random = Math.random() * totalProbability;
  
  let currentProbability = 0;
  let winningPrize = null;
  
  for (const gp of prizes) {
    currentProbability += gp.probability;
    if (random <= currentProbability) {
      winningPrize = gp.prize;
      break;
    }
  }
  
  // 检查奖品库存
  if (winningPrize && winningPrize.remainingQuantity <= 0) {
    winningPrize = null;
  }
  
  return winningPrize;
}
```

#### 5.2.2 免费次数管理
```typescript
function checkFreeDraws(customerId: number, activityId: number): {
  remainingFreeDraws: number,
  pointsCost: number,
  canDraw: boolean
} {
  const freeDrawsPerActivity = 3;
  const usedFreeDraws = await lotteryRecordRepository.count({
    where: { 
      customerId, 
      activityId,
      costPoints: 0 
    },
  });
  
  const remainingFreeDraws = Math.max(0, freeDrawsPerActivity - usedFreeDraws);
  const canUsePoints = remainingFreeDraws === 0;
  
  return {
    remainingFreeDraws,
    pointsCost: activity.minPoints,
    canDraw: remainingFreeDraws > 0 || canUsePoints,
  };
}
```

### 5.3 接口设计

#### 5.3.1 用户端接口

**GET /h5/activities**
- 获取活动列表
- 返回所有"进行中"和"未开始"的活动

**GET /h5/lottery/draw-info/:activityId**
- 查询抽奖信息
- 返回剩余免费次数、积分要求、用户积分

**POST /h5/lottery/draw**
- 执行抽奖
- 请求参数：activityId, gameTypeId
- 返回抽奖结果、奖品信息、积分消耗

**GET /h5/lottery/records**
- 获取抽奖记录
- 支持分页、筛选

**PUT /h5/lottery/records/:recordId/claim**
- 领取实物奖品
- 更新奖品状态为"已领取"

**GET /h5/coupons**
- 获取用户优惠券列表
- 返回优惠券详情、使用状态

**POST /h5/coupons/verify**
- 验证优惠券
- 请求参数：couponCode
- 返回优惠券信息、是否可用

#### 5.3.2 管理端接口

**GET /lottery/records**
- 查看所有抽奖记录
- 支持按活动、用户、时间筛选

**GET /statistics/lottery**
- 抽奖统计数据
- 返回参与人数、中奖率、奖品发放统计

## 6. 业务规则

### 6.1 抽奖规则

1. **免费次数限制**
   - 每个活动每个用户最多3次免费抽奖机会
   - 免费次数用完后，可以消耗积分继续抽奖

2. **积分抽奖规则**
   - 免费次数用完后，每次抽奖消耗活动配置的最低积分
   - 用户积分不足时无法参与抽奖

3. **活动时间限制**
   - 只能在活动有效期内参与抽奖
   - 活动开始前和结束后无法抽奖

4. **奖品概率规则**
   - 所有奖品的概率总和为100%
   - 概率配置在管理端可调整
   - 奖品数量为0时，该奖品不会中奖

5. **奖品库存管理**
   - 奖品数量为0时，视为未中奖
   - 中奖后自动减少奖品库存
   - 库存不足时应该停用该奖品

### 6.2 优惠券规则

1. **优惠券发放**
   - 中奖券类奖品时自动发放
   - 从可用优惠券池中随机选择
   - 创建用户优惠券记录

2. **优惠券使用**
   - 优惠券有有效期限制
   - 优惠券有使用次数限制
   - 使用后更新状态为"已使用"

3. **优惠券类型**
   - 代金券：直接抵扣金额
   - 实物券：兑换指定商品

### 6.3 风险控制

1. **防刷奖**
   - 限制每个用户每日抽奖次数
   - 监控异常抽奖行为
   - 记录详细的抽奖日志

2. **库存保护**
   - 实时监控奖品库存
   - 库存不足时自动停用奖品
   - 避免超发奖品

3. **数据一致性**
   - 使用数据库事务确保数据一致性
   - 抽奖、扣积分、发奖品原子操作
   - 异常时回滚所有操作

## 7. 用户体验

### 7.1 抽奖体验

1. **实时反馈**
   - 抽奖后立即显示结果
   - 动画效果展示抽奖过程
   - 清晰的中奖/未中奖提示

2. **信息透明**
   - 显示剩余免费次数
   - 显示积分消耗情况
   - 显示奖品中奖概率

3. **操作便捷**
   - 一键参与抽奖
   - 快速查看中奖记录
   - 便捷的优惠券使用入口

### 7.2 通知机制

1. **中奖通知**
   - 抽奖中奖后推送通知
   - 显示在用户消息中心
   - 支持短信通知（可选）

2. **优惠券提醒**
   - 优惠券即将过期提醒
   - 优惠券使用提醒
   - 新活动开始通知

## 8. 统计分析

### 8.1 关键指标

1. **参与指标**
   - 活动参与人数
   - 每日抽奖次数
   - 用户参与率

2. **中奖指标**
   - 中奖率（中奖次数/总抽奖次数）
   - 各奖品中奖分布
   - 优惠券发放数量

3. **转化指标**
   - 优惠券使用率
   - 优惠券核销金额
   - 活动ROI分析

### 8.2 报表功能

1. **活动报表**
   - 活动效果分析
   - 参与中奖趋势
   - 奖品消耗统计

2. **用户报表**
   - 用户抽奖行为分析
   - 高价值用户识别
   - 用户流失预警

## 9. 后续优化

### 9.1 功能增强

1. **社交分享**
   - 分享获得额外抽奖机会
   - 邀请好友获得奖励
   - 社交媒体分享功能

2. **个性化推荐**
   - 基于用户行为推荐活动
   - 个性化奖品展示
   - 智能抽奖概率调整

3. **多平台支持**
   - 微信小程序抽奖
   - APP端抽奖功能
   - 公众号抽奖入口

### 9.2 性能优化

1. **缓存优化**
   - 活动信息缓存
   - 奖品库存缓存
   - 用户抽奖次数缓存

2. **并发控制**
   - 抽奖接口限流
   - 防止恶意刷奖
   - 数据库连接池优化

## 10. 版本规划

### 10.1 V1.0（当前版本）
- ✅ 基础抽奖功能
- ✅ 免费次数和积分抽奖
- ✅ 优惠券自动发放
- ✅ 抽奖记录管理
- ✅ 基础统计功能

### 10.2 V1.1（规划中）
- 🔄 社交分享功能
- 🔄 个性化推荐
- 🔄 高级统计分析
- 🔄 活动模板功能

### 10.3 V2.0（未来规划）
- ⏳ AI智能抽奖
- ⏳ 大数据分析
- ⏳ 实时风控系统
- ⏳ 多渠道统一管理

---

**文档版本**: 1.0  
**最后更新**: 2026-02-19  
**维护人**: JunLite CRM Team