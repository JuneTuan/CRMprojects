# V6.0 数据库设计文档

## 📋 文档信息

| 项目 | 内容 |
|------|------|
| 文档版本 | V1.0 |
| 创建日期 | 2026-02-26 |
| 创建人 | 开发团队 |
| 状态 | 草稿 |

---

## 1. 数据库概述

### 1.1 数据库信息
- **数据库名称**: crm_db
- **数据库版本**: MySQL 8.0+
- **字符集**: utf8mb4
- **排序规则**: utf8mb4_general_ci

### 1.2 新增表
V6.0版本新增3张表：
1. **leads** - 销售线索表
2. **lead_followups** - 线索跟进记录表
3. **lead_assignments** - 线索分配历史表

---

## 2. 表结构设计

### 2.1 销售线索表（leads）

#### 2.1.1 表概述
存储销售线索的基本信息，包括线索的来源、状态、分配信息等。

#### 2.1.2 表结构

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|--------|-----------|--------|------|
| id | INT | - | NO | AUTO_INCREMENT | 主键ID |
| name | VARCHAR | 100 | NO | - | 线索姓名 |
| phone | VARCHAR | 20 | NO | - | 电话号码 |
| email | VARCHAR | 100 | YES | - | 邮箱地址 |
| company | VARCHAR | 200 | YES | - | 公司名称 |
| position | VARCHAR | 100 | YES | - | 职位 |
| source | VARCHAR | 50 | NO | - | 来源渠道（网站、电话、展会、推荐、其他） |
| source_detail | VARCHAR | 200 | YES | - | 来源详情 |
| description | TEXT | - | YES | - | 线索描述 |
| priority | VARCHAR | 20 | NO | 'medium' | 优先级（high、medium、low） |
| status | VARCHAR | 20 | NO | 'new' | 状态（new、assigned、contacting、interested、converted、closed） |
| assigned_to | INT | - | YES | - | 分配给的销售人员ID（关联users表） |
| assigned_at | DATETIME | - | YES | - | 分配时间 |
| score | INT | - | YES | 0 | 线索评分（0-100） |
| converted | BOOLEAN | - | NO | FALSE | 是否已转化 |
| converted_at | DATETIME | - | YES | - | 转化时间 |
| converted_amount | DECIMAL | 10,2 | YES | - | 转化金额 |
| converted_customer_id | INT | - | YES | - | 转化的客户ID（关联customers表） |
| closed | BOOLEAN | - | NO | FALSE | 是否已关闭 |
| closed_at | DATETIME | - | YES | - | 关闭时间 |
| close_reason | VARCHAR | 200 | YES | - | 关闭原因 |
| created_by | INT | - | NO | - | 创建人ID（关联users表） |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 2.1.3 索引设计

| 索引名 | 字段 | 类型 | 说明 |
|--------|------|------|------|
| PRIMARY | id | PRIMARY | 主键索引 |
| idx_phone | phone | INDEX | 电话索引 |
| idx_email | email | INDEX | 邮箱索引 |
| idx_status | status | INDEX | 状态索引 |
| idx_assigned_to | assigned_to | INDEX | 分配人索引 |
| idx_created_at | created_at | INDEX | 创建时间索引 |
| idx_converted | converted | INDEX | 转化状态索引 |

#### 2.1.4 外键约束

| 外键名 | 字段 | 关联表 | 关联字段 | 删除规则 | 更新规则 |
|--------|------|--------|----------|----------|----------|
| fk_leads_assigned_to | assigned_to | users | id | SET NULL | CASCADE |
| fk_leads_created_by | created_by | users | id | CASCADE | CASCADE |
| fk_leads_converted_customer_id | converted_customer_id | customers | id | SET NULL | CASCADE |

#### 2.1.5 字段说明

**priority字段**：
- `high`: 高优先级，需要优先处理
- `medium`: 中优先级，正常处理
- `low`: 低优先级，可以延后处理

**status字段**：
- `new`: 新线索，刚创建
- `assigned`: 已分配，已分配给销售人员
- `contacting`: 联系中，销售人员已联系
- `interested`: 意向明确，客户有明确购买意向
- `converted`: 已转化，转化为正式客户
- `closed`: 已关闭，无法转化

### 2.2 线索跟进记录表（lead_followups）

#### 2.2.1 表概述
存储线索的跟进记录，包括联系方式、联系内容、联系结果等。

#### 2.2.2 表结构

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|--------|-----------|--------|------|
| id | INT | - | NO | AUTO_INCREMENT | 主键ID |
| lead_id | INT | - | NO | - | 线索ID（关联leads表） |
| contact_method | VARCHAR | 20 | NO | - | 联系方式（phone、email、sms、meeting） |
| contact_time | DATETIME | - | NO | - | 联系时间 |
| contact_content | TEXT | - | YES | - | 联系内容 |
| contact_result | VARCHAR | 20 | NO | - | 联系结果（success、failed、pending） |
| next_followup | DATETIME | - | YES | - | 下次跟进时间 |
| attachment | VARCHAR | 500 | YES | - | 附件路径 |
| created_by | INT | - | NO | - | 创建人ID（关联users表） |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |

#### 2.2.3 索引设计

| 索引名 | 字段 | 类型 | 说明 |
|--------|------|------|------|
| PRIMARY | id | PRIMARY | 主键索引 |
| idx_lead_id | lead_id | INDEX | 线索ID索引 |
| idx_contact_time | contact_time | INDEX | 联系时间索引 |
| idx_created_by | created_by | INDEX | 创建人索引 |

#### 2.2.4 外键约束

| 外键名 | 字段 | 关联表 | 关联字段 | 删除规则 | 更新规则 |
|--------|------|--------|----------|----------|----------|
| fk_lead_followups_lead_id | lead_id | leads | id | CASCADE | CASCADE |
| fk_lead_followups_created_by | created_by | users | id | CASCADE | CASCADE |

#### 2.2.5 字段说明

**contact_method字段**：
- `phone`: 电话联系
- `email`: 邮件联系
- `sms`: 短信联系
- `meeting`: 面谈

**contact_result字段**：
- `success`: 联系成功
- `failed`: 联系失败
- `pending`: 待跟进

### 2.3 线索分配历史表（lead_assignments）

#### 2.3.1 表概述
存储线索的分配历史，记录线索的分配和重新分配情况。

#### 2.3.2 表结构

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|--------|-----------|--------|------|
| id | INT | - | NO | AUTO_INCREMENT | 主键ID |
| lead_id | INT | - | NO | - | 线索ID（关联leads表） |
| assigned_to | INT | - | NO | - | 分配给的销售人员ID（关联users表） |
| assigned_by | INT | - | NO | - | 分配人ID（关联users表） |
| assigned_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 分配时间 |
| notes | VARCHAR | 500 | YES | - | 分配备注 |

#### 2.3.3 索引设计

| 索引名 | 字段 | 类型 | 说明 |
|--------|------|------|------|
| PRIMARY | id | PRIMARY | 主键索引 |
| idx_lead_id | lead_id | INDEX | 线索ID索引 |
| idx_assigned_to | assigned_to | INDEX | 分配人索引 |
| idx_assigned_at | assigned_at | INDEX | 分配时间索引 |

#### 2.3.4 外键约束

| 外键名 | 字段 | 关联表 | 关联字段 | 删除规则 | 更新规则 |
|--------|------|--------|----------|----------|----------|
| fk_lead_assignments_lead_id | lead_id | leads | id | CASCADE | CASCADE |
| fk_lead_assignments_assigned_to | assigned_to | users | id | CASCADE | CASCADE |
| fk_lead_assignments_assigned_by | assigned_by | users | id | CASCADE | CASCADE |

---

## 3. 表关系图

```
users (用户表)
  ├─ leads.created_by (创建人)
  ├─ leads.assigned_to (分配人)
  ├─ lead_followups.created_by (创建人)
  ├─ lead_assignments.assigned_to (被分配人)
  └─ lead_assignments.assigned_by (分配人)

customers (客户表)
  └─ leads.converted_customer_id (转化的客户)

leads (销售线索表)
  ├─ lead_followups.lead_id (跟进记录)
  └─ lead_assignments.lead_id (分配历史)
```

---

## 4. 数据字典

### 4.1 线索状态字典

| 状态值 | 说明 | 英文 |
|--------|------|------|
| 新线索 | 刚创建的线索 | new |
| 已分配 | 已分配给销售人员 | assigned |
| 联系中 | 销售人员已联系 | contacting |
| 意向明确 | 客户有明确购买意向 | interested |
| 已转化 | 转化为正式客户 | converted |
| 已关闭 | 无法转化，关闭线索 | closed |

### 4.2 线索优先级字典

| 优先级值 | 说明 | 英文 | 权重 |
|----------|------|------|------|
| 高 | 高优先级，需要优先处理 | high | 3 |
| 中 | 中优先级，正常处理 | medium | 2 |
| 低 | 低优先级，可以延后处理 | low | 1 |

### 4.3 线索来源字典

| 来源值 | 说明 | 英文 |
|--------|------|------|
| 网站 | 从网站表单获取 | website |
| 电话 | 从电话咨询获取 | phone |
| 展会 | 从展会获取 | exhibition |
| 推荐 | 从推荐获取 | referral |
| 其他 | 其他渠道 | other |

### 4.4 联系方式字典

| 联系方式 | 说明 | 英文 |
|----------|------|------|
| 电话 | 电话联系 | phone |
| 邮件 | 邮件联系 | email |
| 短信 | 短信联系 | sms |
| 面谈 | 面谈 | meeting |

### 4.5 联系结果字典

| 联系结果 | 说明 | 英文 |
|----------|------|------|
| 成功 | 联系成功 | success |
| 失败 | 联系失败 | failed |
| 待跟进 | 待跟进 | pending |

---

## 5. 数据初始化

### 5.1 初始化SQL

```sql
-- 创建销售线索表
CREATE TABLE `leads` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `name` VARCHAR(100) NOT NULL COMMENT '线索姓名',
  `phone` VARCHAR(20) NOT NULL COMMENT '电话号码',
  `email` VARCHAR(100) DEFAULT NULL COMMENT '邮箱地址',
  `company` VARCHAR(200) DEFAULT NULL COMMENT '公司名称',
  `position` VARCHAR(100) DEFAULT NULL COMMENT '职位',
  `source` VARCHAR(50) NOT NULL COMMENT '来源渠道',
  `source_detail` VARCHAR(200) DEFAULT NULL COMMENT '来源详情',
  `description` TEXT DEFAULT NULL COMMENT '线索描述',
  `priority` VARCHAR(20) NOT NULL DEFAULT 'medium' COMMENT '优先级',
  `status` VARCHAR(20) NOT NULL DEFAULT 'new' COMMENT '状态',
  `assigned_to` INT DEFAULT NULL COMMENT '分配给的销售人员ID',
  `assigned_at` DATETIME DEFAULT NULL COMMENT '分配时间',
  `score` INT DEFAULT 0 COMMENT '线索评分',
  `converted` BOOLEAN NOT NULL DEFAULT FALSE COMMENT '是否已转化',
  `converted_at` DATETIME DEFAULT NULL COMMENT '转化时间',
  `converted_amount` DECIMAL(10,2) DEFAULT NULL COMMENT '转化金额',
  `converted_customer_id` INT DEFAULT NULL COMMENT '转化的客户ID',
  `closed` BOOLEAN NOT NULL DEFAULT FALSE COMMENT '是否已关闭',
  `closed_at` DATETIME DEFAULT NULL COMMENT '关闭时间',
  `close_reason` VARCHAR(200) DEFAULT NULL COMMENT '关闭原因',
  `created_by` INT NOT NULL COMMENT '创建人ID',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_phone` (`phone`),
  KEY `idx_email` (`email`),
  KEY `idx_status` (`status`),
  KEY `idx_assigned_to` (`assigned_to`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_converted` (`converted`),
  CONSTRAINT `fk_leads_assigned_to` FOREIGN KEY (`assigned_to`) REFERENCES `users` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  CONSTRAINT `fk_leads_created_by` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `fk_leads_converted_customer_id` FOREIGN KEY (`converted_customer_id`) REFERENCES `customers` (`id`) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci COMMENT='销售线索表';

-- 创建线索跟进记录表
CREATE TABLE `lead_followups` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `lead_id` INT NOT NULL COMMENT '线索ID',
  `contact_method` VARCHAR(20) NOT NULL COMMENT '联系方式',
  `contact_time` DATETIME NOT NULL COMMENT '联系时间',
  `contact_content` TEXT DEFAULT NULL COMMENT '联系内容',
  `contact_result` VARCHAR(20) NOT NULL COMMENT '联系结果',
  `next_followup` DATETIME DEFAULT NULL COMMENT '下次跟进时间',
  `attachment` VARCHAR(500) DEFAULT NULL COMMENT '附件路径',
  `created_by` INT NOT NULL COMMENT '创建人ID',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_lead_id` (`lead_id`),
  KEY `idx_contact_time` (`contact_time`),
  KEY `idx_created_by` (`created_by`),
  CONSTRAINT `fk_lead_followups_lead_id` FOREIGN KEY (`lead_id`) REFERENCES `leads` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `fk_lead_followups_created_by` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci COMMENT='线索跟进记录表';

-- 创建线索分配历史表
CREATE TABLE `lead_assignments` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `lead_id` INT NOT NULL COMMENT '线索ID',
  `assigned_to` INT NOT NULL COMMENT '分配给的销售人员ID',
  `assigned_by` INT NOT NULL COMMENT '分配人ID',
  `assigned_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '分配时间',
  `notes` VARCHAR(500) DEFAULT NULL COMMENT '分配备注',
  PRIMARY KEY (`id`),
  KEY `idx_lead_id` (`lead_id`),
  KEY `idx_assigned_to` (`assigned_to`),
  KEY `idx_assigned_at` (`assigned_at`),
  CONSTRAINT `fk_lead_assignments_lead_id` FOREIGN KEY (`lead_id`) REFERENCES `leads` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `fk_lead_assignments_assigned_to` FOREIGN KEY (`assigned_to`) REFERENCES `users` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `fk_lead_assignments_assigned_by` FOREIGN KEY (`assigned_by`) REFERENCES `users` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci COMMENT='线索分配历史表';
```

---

## 6. 数据迁移

### 6.1 迁移脚本

```sql
-- V6.0数据库迁移脚本
-- 版本：V6.0
-- 日期：2026-02-26
-- 说明：创建销售线索管理相关表

-- 执行前检查
SELECT '开始执行V6.0数据库迁移...';

-- 创建销售线索表
-- 见5.1节

-- 创建线索跟进记录表
-- 见5.1节

-- 创建线索分配历史表
-- 见5.1节

-- 执行后检查
SELECT 'V6.0数据库迁移完成！';
```

### 6.2 回滚脚本

```sql
-- V6.0数据库回滚脚本
-- 版本：V6.0
-- 日期：2026-02-26
-- 说明：回滚V6.0数据库变更

-- 执行前检查
SELECT '开始执行V6.0数据库回滚...';

-- 删除线索分配历史表
DROP TABLE IF EXISTS `lead_assignments`;

-- 删除线索跟进记录表
DROP TABLE IF EXISTS `lead_followups`;

-- 删除销售线索表
DROP TABLE IF EXISTS `leads`;

-- 执行后检查
SELECT 'V6.0数据库回滚完成！';
```

---

## 7. 性能优化

### 7.1 索引优化
- 为常用查询字段添加索引
- 为外键字段添加索引
- 为排序字段添加索引
- 定期分析索引使用情况，删除无用索引

### 7.2 查询优化
- 使用EXPLAIN分析慢查询
- 优化JOIN查询
- 避免SELECT *
- 使用LIMIT限制返回结果

### 7.3 分区策略
- 按时间分区：leads表按created_at字段分区
- 分区粒度：按月分区
- 分区数量：保留最近12个月的数据

---

## 8. 数据安全

### 8.1 数据加密
- phone字段：使用AES加密
- email字段：使用AES加密
- 其他敏感字段：根据需要加密

### 8.2 数据备份
- 每日全量备份
- 每小时增量备份
- 备份保留30天
- 备份文件加密存储

### 8.3 数据审计
- 记录所有数据变更
- 记录变更前后的值
- 记录变更人和变更时间

---

## 9. 附录

### 9.1 变更历史

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|----------|--------|
| V1.0 | 2026-02-26 | 初始版本 | 开发团队 |

### 9.2 参考文档
- V6.0销售线索管理需求文档
- V6.0API设计文档
- MySQL官方文档

---

**文档版本**: V1.0  
**创建日期**: 2026-02-26  
**最后更新**: 2026-02-26  
**状态**: 草稿
